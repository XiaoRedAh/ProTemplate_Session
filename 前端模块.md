# 前置工作

## 创建项目

添加一个vue3模块，在控制台输入：

```
npm install -g create-vue
create-vue
```

然后去“项目结构”，把创建好的前端模块添加到项目中

然后把vue官方的样例删了，留下前端框架就行

## 安装各种东东

**注意：一定先切换到前端项目的路径下下载**

![](img/%E4%B8%8B%E8%BD%BDelementplus%E6%97%B6%E6%B3%A8%E6%84%8F%E5%88%87%E6%8D%A2%E5%88%B0%E5%89%8D%E7%AB%AF%E8%B7%AF%E5%BE%84%E4%B8%8B.png)

### 下载element plus

根据官方文档的指引

先

```
npm install element-plus --save
```

然后在main.js中

```
import 'element-plus/dist/index.css'
```

然后安装“按需导入”的插件（这样节省空间）

```
npm install -D unplugin-vue-components unplugin-auto-import
```

最后vite.config.js中添加

```js
// vite.config.ts
import { defineConfig } from 'vite'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  // ...
  plugins: [
    // ...
    AutoImport({
      resolvers: [ElementPlusResolver()],
    }),
    Components({
      resolvers: [ElementPlusResolver()],
    }),
  ],
})
```

### 下载axios

异步请求框架

```
npm install vue-axios --save
npm install axios
```

#### 配置axios请求前缀

main.js

```js
//配置服务器地址（后端）前缀（https为什么不行）
axios.defaults.baseURL='http://localhost:8080'
```

这样前后端的数据就可以对接了

#### 封装axios请求方法

创建src/net/index.js

```js
import axios from "axios";
import {ElMessage} from "element-plus";

//失败和异常给个默认处理就行
const defaultError = ()=>ElMessage.error('发生了一些错误，请联系管理员')
const defaultFailure = (message)=>ElMessage.warning(message)

//封装axios的post方法
//data就是接收后端响应过来的数据。后端那边统一了响应类，也就是RestBean
function post(url, data, success, failure = defaultFailure, error = defaultError){
    axios.post(url, data, {//配置
        //由于都是以表单形式提交，因此设置headers的Content-Type为表单形式
        headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        withCredentials: true//发起请求，携带cookie（基于session的校验需要cookie，以后用jwt的时候就不用cookie了）
    }).then(({data})=>{
        if(data.success)
            success(data.message, data.status)
        else
            failure(data.message, data.status)
    }).catch(error)
}

//封装axios的get方法（get没有data）
function get(url, success, failure = defaultFailure, error = defaultError){
    axios.get(url,{
        //因为get方法不需要提交东西，所以不用配置headers
        withCredentials: true//发起请求，携带cookie（基于session的校验需要cookie，以后用jwt的时候就不用cookie了）
    }).then(({data})=>{
        if(data.success)
            success(data.message, data.status,)
        else
            failure(data.message, data.status)
    }).catch(error)
}

//封装好后，暴露出去
export {get, post}
```

# 未登录时的欢迎界面

## 需求

**说明**

在欢迎首页中，左侧的壁纸固定不变，右侧内容根据路由变化，展示登录/注册/忘记密码界面。

那么可以把欢迎界面写为一个WelcomeViews.vue，其中右侧内容通过路由选择展示LoginPage.vue组件或RegisterPage.vue组件或ForgetPassword.vue组件

**登录界面**

![](img/%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2.png)

**注册界面**

![](img/%E6%B3%A8%E5%86%8C%E7%95%8C%E9%9D%A2.png)

**忘记密码界面**

![](img/%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81%E7%95%8C%E9%9D%A2.png)

## 总体页面

src/views/WelcomeViews.vue

```js
<template>
  <div style="width: 100vw;height: 100vh;overflow: hidden;display: flex">
    <!--左侧壁纸固定-->
    <div style="flex:1">
      <img style="width: 100%;height: 100%" fit ="cover" src="@/assets/img/login.png"/>
    </div>
    <div class="welcome-title">
      <div style="font-size: 30px;font-weight: bold">欢迎来到xiaoRed的网站</div>
      <div style="margin-top: 10px">水一段话啦啦啦啦啦啦</div>
      <div style="margin-top: 5px">再水一段话啦啦啦啦啦啦</div>
    </div>
    <!--右侧：根据路由展示登录/注册/忘记密码组件-->
    <div style="width: 450px;text-align: center;background-color: white;z-index: 1">
      <!--根据路由切换展示的组件-->
      <router-view v-slot = "{Component}">
        <!--给切换组件添加一个过渡动画-->
        <transition name="el-fade-in-linear">
          <component :is="Component" style="height: 100%"/>
        </transition>
      </router-view>
    </div>

  </div>
</template>

<script setup>

</script>

<style scoped>
.welcome-title{
  position: absolute;
  bottom: 30px;
  left: 30px;
  color: white;
  text-shadow: 0 0 10px black;
}
</style>
```

## 基本路由配置

路由配置需要二级路由。第一级就是这个WelcomeViews.vue，子路由负责右侧内容的变化，展示登录/注册/忘记密码组件

src/router/index.js

```js
import { createRouter, createWebHistory } from 'vue-router'


const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      //路由1：默认路径
      //第一层路由，展示WelcomeViews.vue
      path: '/',
      name: 'welcome',
      component: ()=>import('@/views/WelcomeViews.vue'),
      //第二层子路由：据路由不同，WelcomeViews.vue右侧展示的组件不同
      children: [
        {
          //path什么都不写，默认展示登录界面的组件
          path: '',
          name: 'welcome-login',
          component: ()=>import('@/components/welcome/LoginPage.vue')
        },{
          //路由到注册页面的组件
          path: 'register',
          name: 'welcome-register',
          component: ()=>import('@/components/welcome/RegisterPage.vue')
        },{
          //路由到忘记密码的组件
          path: 'forget',
          name: 'welcome-forget',
          component: ()=>import('@/components/welcome/ForgetPawPage.vue')
        }
      ]
    },
    //路由2：登录成功后的界面
    {
      path: '/index',
      name: 'index',
      component:()=>import('@/views/indexView.vue')
    }

  ]
})

export default router
```

App.vue的template中添加

```js
<template>
 <router-view></router-view>
</template>
```

## 登录页面

### 界面搭建

① src/components/welcome/LoginPage.vue

```js
<template>
  <div style="text-align: center;margin: 0 20px">
    <div style="margin-top: 200px">
      <div style="font-size: 25px;font-weight: bold">登录</div>
      <div style="font-size: 14px;color:grey">输入用户名和密码进行登录</div>
    </div>
    <div style="margin-top: 50px">
      <el-input type="text" placeholder="用户名/邮箱">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><User /></el-icon>
        </template>
      </el-input>
      <el-input type="password" style="margin-top: 20px" placeholder="密码">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><Lock /></el-icon>
        </template>
      </el-input>
    </div>
    <div style="margin-top: 10px">
      <el-row>
        <el-col :span="12" style="text-align: left">
          <el-checkbox v-model="checked1" label="记住我" size="large" />
        </el-col>
        <el-col :span="12" style="text-align: right">
          <el-link>忘记密码？</el-link>
        </el-col>
      </el-row>
    </div>
    <div style="margin-top: 40px">
      <el-button style="width: 270px" type="success" plain>登录</el-button>
    </div>
    <el-divider>
      <span style="color: grey;font-size: 13px">没有账号</span>
    </el-divider>
    <div>
      <el-button style="width: 270px" type="warning" plain>注册账号</el-button>
    </div>
  </div>
</template>

<script setup>
import {User,Lock} from '@element-plus/icons-vue'
</script>

<style scoped>

</style>
```

② 写个登录成功后的页面方便后面测试

src/views/indexView.vue

```js
<template>
  <div>
    欢迎进入
  </div>
  <div>
    <el-button type="danger" plain>退出登录</el-button>
  </div>

</template>

<script>
export default {
  name: "indexView.vue"
}
</script>

<style scoped>

</style>
```

### 发送请求及处理响应

#### 登录功能

src/components/welcome/LoginPage.vue

① 编写js

```js
<script setup>
import {User,Lock} from '@element-plus/icons-vue'
import {reactive} from "vue";
import {ElMessage} from "element-plus";
import {post} from '@/net'
import router from "@/router";

//绑定username,password,remember数据
const form = reactive({
  username: '',
  password: '',
  remember: false
})
//点击“登录”
const login = () =>{
  if(!form.username||!form.password){
    ElMessage.warning("请填写用户名和密码")
  }else{
    //向后端发送对应路径的post请求，携带以下四个参数
    post('/api/auth/login',{
      username: form.username,
      password: form.password,
      remember: form.remember
    },(message) =>{
      //登录成功，跳转到index
      ElMessage.success(message)
      router.push('/index')
    })
  }
}
</script>
```

② 绑定表单数据和点击函数

```js
...
<el-input v-model="form.username" type="text" placeholder="用户名/邮箱">
...
<el-input v-model="form.password" type="password" style="margin-top: 20px" placeholder="密码">
...
<el-checkbox v-model="form.remember" label="记住我" size="large" />
...
<el-button @click="login()" style="width: 270px" type="success" plain>登录</el-button>
...
```

#### 登出功能

src/views/indexView.vue

```js
<template>
  <div>
    欢迎进入
  </div>
  <div>
    <el-button @click="logout()" type="danger" plain>退出登录</el-button>
  </div>

</template>

<script setup>
import {get} from "@/net"
import {ElMessage} from "element-plus";
import router from "@/router";
const logout = ()=>{
  //向后端发送对应路径的get请求
  get('/api/auth/logout',(message) =>{
    //退出登录成功，跳转到登录界面
    ElMessage.success(message)
    router.push('/')
  })
}
```

## 注册页面

### 界面搭建

① src/components/welcome/RegisterPage.vue

```js
<template>
  <div style="text-align: center;margin: 0 20px">
    <div style="margin-top: 200px">
      <div style="font-size: 25px;font-weight: bold">注册新用户</div>
      <div style="font-size: 14px;color:grey">欢迎注册，请在下方填写相关信息</div>
    </div>
    <div style="margin-top: 50px">
      <el-input v-model="form.username" type="text" placeholder="用户名">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><User /></el-icon>
        </template>
      </el-input>
      <el-input v-model="form.password" type="password" style="margin-top: 20px" placeholder="密码">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><Lock /></el-icon>
        </template>
      </el-input>
      <el-input v-model="form.password_repeat" type="password" style="margin-top: 20px" placeholder="再次输入密码">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><Lock /></el-icon>
        </template>
      </el-input>
      <el-input v-model="form.email" type="email" style="margin-top: 20px" placeholder="电子邮箱地址">
        <!--给输入框引入一个图标-->
        <template #prefix>
          <el-icon><Message /></el-icon>
        </template>
      </el-input>
    </div>
    <div style="margin-top: 20px">
      <el-row :gutter="10" style="width: 100%">
        <el-col :span="18">
          <el-input v-model="form.code" type="text" placeholder="请输入验证码">
            <!--给输入框引入一个图标-->
            <template #prefix>
              <el-icon><EditPen /></el-icon>
            </template>
          </el-input>
        </el-col>
        <el-col :span="6">
          <el-button type="success">获取验证码</el-button>
        </el-col>
      </el-row>
    </div>
    <div style="margin-top: 80px">
      <el-button style="width: 270px" type="warning" plain>注册</el-button>
    </div>
    <div style="margin-top: 20px">
      <span style="font-size: 14px;line-height: 15px;color: grey">已有帐号？</span>
      <el-link type="primary" style="translate: 0 -2px" @click="router.push('/')">立即登录</el-link>
    </div>
  </div>
</template>

<script setup>
import {User, Lock, Message, EditPen} from "@element-plus/icons-vue";
import router from "@/router";
import {reactive} from "vue";

const form = reactive({
  username: '',
  password: '',
  password_repeat: '',
  email: '',
  code: ''
})
</script>

<style scoped>

</style>
```

②  src/components/welcome/LoginPage.vue的登录按钮配置路由跳转到注册界面

```js
<div>
      <el-button @click="router.push('/register')" style="width: 270px" type="warning" plain>注册账号</el-button>
</div>
```

### 表单校验

#### 需求

* 在用户输入的时候进行相应提示
* 只有电子邮箱合法，“获取验证码”按钮才生效
* 只有完整且正确地填写表单，注册按钮才会将数据发送给后端，否则给出错误提示

![](img/%E6%B3%A8%E5%86%8C%E7%95%8C%E9%9D%A2%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C%E9%9C%80%E6%B1%82.png)

**用element plus的el-form表单帮助校验**

#### el-form实现表单校验

**用法参考官方文档**

##### 引入el-form

①将需要表单校验的部分用`<el-form>`包装起来，里面每一个输入框，按钮用`<el-form-item>`装起来

② `<el-form :model="form">`绑定表单数据
```js
...
<el-form :model="form" :rules="rules" @validate="onValidate">
        <el-form-item prop="username">
          <el-input v-model="form.username" type="text" placeholder="用户名">
            <!--给输入框引入一个图标-->
            <template #prefix>
              <el-icon><User /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item prop="password">
          <el-input v-model="form.password" type="password" style="margin-top: 20px" placeholder="密码">
            <!--给输入框引入一个图标-->
            <template #prefix>
              <el-icon><Lock /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item prop="password_repeat">
          <el-input v-model="form.password_repeat" type="password" style="margin-top: 20px" placeholder="再次输入密码">
            <!--给输入框引入一个图标-->
            <template #prefix>
              <el-icon><Lock /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item prop="email">
          <el-input v-model="form.email" type="email" style="margin-top: 20px" placeholder="电子邮箱地址">
            <!--给输入框引入一个图标-->
            <template #prefix>
              <el-icon><Message /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item>
          <div style="margin-top: 20px">
            <el-row :gutter="10" style="width: 100%">
              <el-col :span="18">
                <el-input v-model="form.code" type="text" placeholder="请输入验证码">
                  <!--给输入框引入一个图标-->
                  <template #prefix>
                    <el-icon><EditPen /></el-icon>
                  </template>
                </el-input>
              </el-col>
              <el-col :span="6">
                <el-button type="success" :disabled="!isEmailValid">获取验证码</el-button>
              </el-col>
            </el-row>
          </div>
        </el-form-item>
      </el-form>
      ...
```

##### 制定校验规则

① 给每个`<el-form-item>`添加对应的prop属性（来自传入el-form组件的model中的字段）【为了form表单在使用校验函数的时候能对得上号】

```js
    ...
    <el-form-item prop="username">
          ...
    </el-form-item>
    <el-form-item prop="password">
          ...
    </el-form-item>
    <el-form-item prop="password_repeat">
          ...
    </el-form-item>
    <el-form-item prop="email">
          ...
    </el-form-item>
    ...
```

② 制定校验规则(抄官网例子，按需改下代码)

```js
//校验“用户名输入框”不能有特殊字符
const validateUsername = (rule, value, callback) => {
  if (value === '') {
    callback(new Error('请输入用户名'));
  } else {
    //用正则表达式判断更方便。（以下正则表达式含义：包含中文英文的用户名，不能有特殊字符）
    if (!/^[a-zA-Z0-9\u4e00-\u9fa5]+$/.test(value)) {
      callback(new Error('用户名不能包含特殊字符，只能是中文/英文'));
    }else{
      callback();
    }
  }
};

const validatePassword = (rule, value, callback) => {
  if (value === '') {
    callback(new Error('请再次输入密码'));
  } else if (value !== form.password) {
    callback(new Error('两次输入密码不一致!'));
  } else {
    callback();
  }
};
//制定校验规则
const rules ={
  username: [
    { validator: validateUsername, trigger: ['blur','change'] },
    { min: 2, max: 8, message: '用户名长度必须在2~8个字符之间', trigger: ['blur','change'] }
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, max: 16, message: '密码长度必须在6~16个字符之间', trigger: ['blur','change'] }
  ],
  password_repeat: [
    { validator: validatePassword, trigger: ['blur','change'] },
  ],
  email:[
    { required: true, message: '请输入邮箱地址', trigger: 'blur' },
    { type: 'email', message: '请输入合法的电子邮箱地址', trigger: ['blur', 'change'] }
  ],
  code: [
    { required: true, message: '请输入获取的验证码', trigger: 'blur' }
  ]
}
//定义对整个表单进行响应的变量
const formRef = ref()
//判断邮箱地址是否有效（默认无效），有效才能激发“获取验证码”按钮
const isEmailValid = ref(false)

const onValidate= (prop, isValid) =>{
  //如果更新的属性是email
  if(prop === 'email')
    isEmailValid.value = isValid//isVaild返回的是该属性是否校验通过
}
```

③ `<el-form>`中绑定规则，email合法认证函数，表单响应变量

```js
<el-form :model="form" :rules="rules" @validate="onValidate" ref="formRef">
```

④ “获取验证码”按钮绑定isEmailValid

```js
<el-button type="success" :disabled="!isEmailValid">获取验证码</el-button>
```

### 发送请求及处理响应

#### 发送验证码功能

除了发送请求外，还优化了发送验证码冷却时间在前端的展示

```js
//向后端发送对应路径的post请求（发送验证码请求），携带1个参数
const validateEmail = ()=>{
  //按钮点完立即冷却60秒，防止点太快，发两次
  coldTime.value = 60
  post('/api/auth/valid-reset-email',{
    //传给后端的参数
    email: form.email
  },(message)=>{
    ElMessage.success(message)
    //将冷却时间设为1分钟，给它个定时器，每秒-1
    setInterval(()=>coldTime.value--, 1000)
  },(message)=>{
    //如果发送失败。立即将冷却归0
    ElMessage.warning(message)
    coldTime.value = 0
  })
}
```

“发送验证码”按钮优化

```js
<el-button type="success" :maxlength="6" @click="validateEmail"
                           :disabled="!isEmailValid || coldTime > 0" >
                  {{coldTime > 0 ? '请稍后' + coldTime + '秒' : '获取验证码'}}</el-button>
```

#### 注册功能

```js
//绑定给注册按钮的
const register = ()=>{
  formRef.value.validate((isValid) =>{
  //只有整个el-form表单完整无误，才能向后端发送注册请求，携带四个参数
    if(isValid){
      post("/api/auth/register",{
        username: form.username,
        password: form.password,
        email: form.email,
        code: form.code
      },(message)=>{
        //如果后端注册成功，页面切换到登录界面
        ElMessage.success(message)
        router.push('/')
      })
    }else{//填写表单有误，不能向后端发送post请求
      ElMessage.warning('请完整填写注册表单内容')
    }
  })
}
```

绑定给“注册”按钮

```js
<el-button style="width: 270px" type="warning" plain @click="register">注册</el-button>
```

## 忘记密码页面

### 需求

* 首先发送验证码
* 如果验证成功后才能重置密码（分为两步：验证和重置）
* 表单校验要求同注册页面

![](img/%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81%E7%95%8C%E9%9D%A2%E9%9C%80%E6%B1%82.png)


### 页面搭建

① src/components/welcome/ForgetPawPage.vue

和注册页面功能几乎一样，基本都可以复用注册页面的代码

无非就是多了个从element-plus引入的步骤条，进行到不同步骤，展示不同页面内容

```js
<template>
  <div>
    <div style="margin: 40px 20px;">
      <!--搞个步骤条，active绑定进行到第几步-->
      <el-steps :active="active" finish-status="success" align-center>
        <el-step title="验证电子邮箱" />
        <el-step title="重新设置密码" />
      </el-steps>
    </div>
    <!--active为0的时候显示验证电子邮箱的界面-->
    <transition name="el-fade-in-linear" mode="out-in">
      <div style="text-align: center;margin: 0 20px;height: 100%" v-if="active === 0">
        <div style="margin-top: 150px">
          <div style="font-size: 25px;font-weight: bold">重置密码</div>
          <div style="font-size: 14px;color:grey">请输入需要重置密码的电子邮箱地址</div>
        </div>
        <div>
          <el-form :model="form" :rules="rules" @validate="onValidate" ref="formRef">
            <el-form-item prop="email">
              <el-input v-model="form.email" type="email" style="margin-top: 40px" placeholder="电子邮箱地址">
                <!--给输入框引入一个图标-->
                <template #prefix>
                  <el-icon><Message /></el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item prop="code">
              <div style="margin-top: 20px">
                <el-row :gutter="10" style="width: 100%">
                  <el-col :span="18">
                    <el-input v-model="form.code" type="text" placeholder="请输入验证码">
                      <!--给输入框引入一个图标-->
                      <template #prefix>
                        <el-icon><EditPen /></el-icon>
                      </template>
                    </el-input>
                  </el-col>
                  <el-col :span="6">
                    <el-button type="success" :maxlength="6" @click="validateEmail"
                               :disabled="!isEmailValid || coldTime > 0" >
                      {{coldTime > 0 ? '请稍后' + coldTime + '秒' : '获取验证码'}}</el-button>
                  </el-col>
                </el-row>
              </div>
            </el-form-item>
          </el-form>
        </div>
        <div style="margin-top: 70px">
          <el-button style="width: 270px;" type="danger" plain @click="active=1">开始重置密码</el-button>
        </div>
      </div>
    </transition>
    <!--active为1的时候，显示重置密码界面-->
    <transition name="el-fade-in-linear" mode="out-in">
      <div style="text-align: center;margin: 0 20px;height: 100%" v-if="active === 1">
        <div style="margin-top: 150px">
          <div style="font-size: 25px;font-weight: bold">重置密码</div>
          <div style="font-size: 14px;color:grey">请填写您的新密码</div>
        </div>
        <div style="margin-top: 50px">
          <el-form :model="form" :rules="rules" @validate="onValidate" ref="formRef">
            <el-form-item prop="password">
              <el-input v-model="form.password" :maxlength="16" type="password" style="margin-top: 20px" placeholder="密码">
                <!--给输入框引入一个图标-->
                <template #prefix>
                  <el-icon><Lock /></el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item prop="password_repeat">
              <el-input v-model="form.password_repeat" :maxlength="16" type="password" style="margin-top: 20px" placeholder="再次输入密码">
                <!--给输入框引入一个图标-->
                <template #prefix>
                  <el-icon><Lock /></el-icon>
                </template>
              </el-input>
            </el-form-item>
          </el-form>
        </div>
        <div style="margin-top: 70px">
          <el-button style="width: 270px;" type="danger" plain @click="active=1">立即重置密码</el-button>
        </div>
      </div>
    </transition>
  </div>
</template>

<script setup>
import {reactive, ref} from "vue";
import {Lock, Message, EditPen} from "@element-plus/icons-vue";

const form = reactive({
  email: '',
  code: '',
  password: '',
  password_repeat: ''
})

//步骤条进行到第几步
const active = ref(0)

const validatePassword = (rule, value, callback) => {
  if (value === '') {
    callback(new Error('请再次输入密码'));
  } else if (value !== form.password) {
    callback(new Error('两次输入密码不一致!'));
  } else {
    callback();
  }
};

const rules = {
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, max: 16, message: '密码长度必须在6~16个字符之间', trigger: ['blur','change'] }
  ],
  password_repeat: [
    { validator: validatePassword, trigger: ['blur','change'] },
  ],
  email:[
    { required: true, message: '请输入邮箱地址', trigger: 'blur' },
    { type: 'email', message: '请输入合法的电子邮箱地址', trigger: ['blur', 'change'] }
  ],
  code: [
    { required: true, message: '请输入获取的验证码', trigger: 'blur' }
  ]
}
//定义对整个表单进行响应的变量
const formRef = ref()
//判断邮箱地址是否有效（默认无效），有效才能激发“获取验证码”按钮
const isEmailValid = ref(false)
//发送验证码的冷却时间
const coldTime = ref(0)

const onValidate= (prop, isValid) =>{
  //如果更新的属性是email
  if(prop === 'email')
    isEmailValid.value = isValid//isVaild返回的是该属性是否校验通过
}
</script>

<style scoped>

</style>
```

② src/components/welcome/LoginPage.vue的忘记密码链接绑定路由到忘记密码页面

```js
<el-link @click="router.push('/forget')">忘记密码？</el-link>
```

### 发送请求及处理响应

#### 发送验证码

```js
//向后端发送对应路径的post请求（发送验证码请求），携带1个参数
const validateEmail = ()=>{
  //按钮点击后立即冷却60秒，防止点太快，发两次
  coldTime.value = 60
  post('/api/auth/valid-register-email',{
    //传给后端的参数
    email: form.email
  },(message)=>{
    ElMessage.success(message)
    setInterval(()=>coldTime.value--, 1000)
  },(message)=>{
    //发送失败，冷却直接归0
    ElMessage.warning(message)
    coldTime.value = 0
  })
}
```

绑定

```js
<el-button type="success" :maxlength="6" @click="validateEmail"
                               :disabled="!isEmailValid || coldTime > 0" >
                      {{coldTime > 0 ? '请稍后' + coldTime + '秒' : '获取验证码'}}</el-button>
```

#### 重置密码功能

```js
//重置密码第一步：认证邮箱
const startReset = ()=>{
  formRef.value.validate((isValid) =>{
    //只有整个el-form表单完整无误，才能向后端发送注册请求，携带两个参数
    if(isValid){
      post("/api/auth/start-reset",{
        email: form.email,
        code: form.code
      },()=>{
        //如果邮箱验证成功，进入第二步
        active.value++
      })
    }else{//填写表单有误，不能向后端发送post请求
      ElMessage.warning('请填写电子邮箱地址和验证码')
    }
  })
}
//重置密码第二步：重置密码
const doReset = ()=>{
  formRef.value.validate((isValid) =>{
    //只有整个el-form表单完整无误，才能向后端发送注册请求，携带1个参数
    if(isValid){
      post("/api/auth/do-reset",{
        password: form.password,
      },(message)=>{
        //如果重置密码成功，页面切换到登录界面
        ElMessage.success(message)
        router.push('/')
      })
    }else{//填写表单有误，不能向后端发送post请求
      ElMessage.warning('请填写新的密码并确认两次填写是否一致')
    }
  })
}
```

绑定

```js
<el-button style="width: 270px;" type="danger" plain @click="startReset">开始重置密码</el-button>
```

```js
<el-button style="width: 270px;" type="danger" plain @click="doReset">立即重置密码</el-button>
```

## 页面跳转拦截

### 需求

* 在一开始的时候，无论是否登录，前端直接向后端请求用户信息
  如果请求成功，说明已经登录了，把后端给的用户信息存储起来
  如果请求失败，说明没有登录，跳转到登录页面
* 对于没登录的用户
  * 直接请求index下的页面会被重定向回登录页面
  * 请求不存在的页面，也会被重定向到登录页面
  * 登录成功后，跳转到index页面
* 对于已登录的用户
  * 无法访问欢迎页面相关的页面（登录，注册，忘记密码）
  * 访问不存在的页面会重定向到index页面

### App.vue

这里实现的是：在一开始的时候，无论是否登录，前端直接向后端请求用户信息

由于在App.vue，一次只会在创建页面的时候请求一次

```js
<script setup>
import {get} from "@/net";
import {ElMessage} from "element-plus";
import {useStore} from "@/stores";
import router from "@/router";
//存储用户信息的全局变量
const store = useStore()

if(store.auth.user == null){//如果存储的用户信息为空，则请求获取用户信息
  get('/api/user/me',(message)=>{
    //如果获取成功，说明用户已登录。
    // 那么先将用户信息存储，然后自动跳转到index页面（不会再展示登录页面了）
    store.auth.user = message
    router.push('/index')
  },()=>{
    //如果获取失败，依然置为空
   store.auth.user = null
  })

}

</script>
```

### 配置pinia

把后端传来的用户信息存储为全局变量，需要用的时候就很方便

src/stores/index.js

```js
import {ref, computed, reactive} from 'vue'
import { defineStore } from 'pinia'
//把获取到的用户信息存储为全局变量，需要用的时候就很方便
export const useStore = defineStore('store', () => {
  const auth = reactive({
    user: null
  })

  return { auth }
})
```

### 配置路由守护

src/router/index.js

```js
//路由守卫
router.beforeEach((to, from, next)=>{
  const store = useStore()//用户的信息存储在这个全局变量里
  if(store.auth.user != null && to.name.startsWith('welcome-')){//用户已经登录且请求的页面的name以welcome-开头
    next('/index')//丢到index页面，不能回到关于欢迎的页面（登录，注册，重置密码）
  }else if(store.auth.user == null && to.fullPath.startsWith('/index')){//用户没有登录且请求的页面路径以index开头
    next('/')//不能让他访问，丢到登录页面
  }else if(to.matched.length === 0){//请求的页面不存在
    next('/index')//先丢到index页面。对于已登录的用户，就会展现index页面；对于没登录的用户，则会再被丢到登录页面
  }else{//其他情况该去哪去哪
    next()
  }
})
```

### 修改logout()

src/views/indexView.vue

```js
const store = useStore()//用户信息存储在这个全局变量中
const logout = ()=>{
  //向后端发送对应路径的get请求
  get('api/auth/logout',(message) =>{//退出登录成功
    //先把用户的登录状态清空，才能成功返回到登录页面（配置了路由守卫，如果不清空，前端还是认为你是登录状态，回不到登录页面）
    ElMessage.success(message)
    store.auth.user = null
    router.push('/')//跳转回登录页面
  })
}
```

### 修改login()

src/components/welcome/LoginPage.vue

```js
const store = useStore()//用户信息存储在这个全局变量中
//点击“登录”
const login = () =>{
  if(!form.username||!form.password){
    ElMessage.warning("请填写用户名和密码")
  }else{
    //使用封装好的post方法
    post('/api/auth/login',{
      username: form.username,
      password: form.password,
      remember: form.remember
    },(message) =>{//登录成功
      ElMessage.success(message)
      //先获取用户信息
      get('/api/user/me',(message)=>{
        //获取成功，就将用户信息存储在前端，然后才跳转到index
        store.auth.user = message
        router.push('/index')
      },()=>{
        store.auth.user = null
      })
    })
  }
}
```
